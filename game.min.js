const img=a=>{const b=new Image;return b.src=a,b},IMG_FLOOR=img("img_prod/floor-min.png"),IMG_WALL_N=img("img_prod/wall_n-min.png"),TILE_SIZE=64,PLAYER_SIZE=TILE_SIZE/2,MAP_SIZE=50,VIEWPORT=18,VIEWPORT_SIZE=TILE_SIZE*VIEWPORT,DIR=["s","n","e","w"],_=1,_BG="bg",_O="r",_H="h",_R="k",_D="d",_B="b",_P="p",_R_N="r_n",E_S="e_s",C={},IMG={};C[E_S]="#ceceb5",C[_BG]="black",C[_O]="#777",C[_H]=C[_O],C[_R]="#141111",C[_R_N]=C[_R],C[_D]="#513520",C[_B]="#c1ad9e",C[_P]="orange",IMG[_O]=IMG_FLOOR,IMG[_H]=IMG_FLOOR,IMG[_R_N]=IMG_WALL_N,IMG[_D]=IMG_FLOOR,IMG[_B]=IMG_FLOOR;class Sprite{constructor(a,b,e){this.img=new Image,this.img.src=a,this.width=b,this.height=e,this.getDrawArgsForIndex=this.getDrawArgsForIndex.bind(this)}getDrawArgsForIndex(a,b,e){const f=this.width,j=this.height;return[this.img,a*f,0,f,j,b,e,f,j]}}class Item{constructor(a,b){this.x=a,this.y=b}}class Oil extends Item{constructor(a,b){super(a,b),this.img=img("img_prod/oil-min.png")}}class Picture extends Item{constructor(a,b){super(a,b),this.img=img("img_prod/picture-min.png")}}class Room{constructor(a,b,e,f){this.x=a,this.y=b,this.width=e,this.height=f}randomLocationInRoom(){return{x:this.x+Math.floor(Math.random()*this.width),y:this.y+Math.floor(Math.random()*this.height)}}}class Dungeon{constructor(a){this.characters=[],this.items=[],this.canvas=a,this.ctx=this.canvas.getContext("2d"),this.map=Array(MAP_SIZE),this.s_door_ns=new Sprite("img_prod/s_doors_ns-min.png",TILE_SIZE,TILE_SIZE),this.s_door_ew=new Sprite("img_prod/s_doors_ew-min.png",TILE_SIZE,TILE_SIZE);for(let b=0;b<MAP_SIZE;b++){this.map[b]=Array(MAP_SIZE);for(let e=0;e<MAP_SIZE;e++)this.map[b][e]=_R}this.generate()}placeCharacter(a){this.characters.unshift(a)}setPlayer(a){this.player=a}generateRooms(a){let l=[];const n=(q,r)=>{return q.x<r.x+r.width&&q.x+q.width>r.x&&q.y<r.y+r.height&&q.height+q.y>r.y},o=q=>{let r=!0;return l.forEach(s=>{!1==r||n(s,q)&&(r=!1)}),r};for(let q=0;q<800;q++){const r=7+Math.round(Math.random()*11),s=7+Math.round(Math.random()*11),t=Math.round(Math.random()*(MAP_SIZE-r-1)),u=Math.round(Math.random()*(MAP_SIZE-s-1)),v=new Room(t,u,r,s);o(v)&&l.push(v)}return l.map(q=>{q.x+=_,q.width-=_,q.y+=_,q.height-=_;for(let r=q.y;r<q.y+q.height;r++)for(let s=q.x;s<q.x+q.width;s++)a[r][s]=_O,r===q.y&&(a[r-1][s]=_R_N);return q})}generateMaze(){const a=this.map,b=1,e=()=>{return DIR[Math.round(Math.random()*DIR.length)]},f=(j,k,l,n,o)=>{const q=a[k][j];if(q!=l)return!1;if(q!=_R)return!1;let r=!0;if("s"===o?a[k+b]&&a[k+b][j]==_R&&a[k][j-b]==_R&&a[k][j+b]==_R||(r=!1):"n"===o?a[k-b]&&a[k-b][j]==_R&&a[k][j-b]==_R&&a[k][j+b]==_R||(r=!1):"w"===o?a[k][j-b]&&a[k][j-b]==_R&&a[k+b]&&a[k+b][j]==_R&&a[k-b]&&a[k-b][j]==_R||(r=!1):"e"===o?a[k][j+b]&&a[k][j+b]==_R&&a[k+b]&&a[k+b][j]==_R&&a[k-b]&&a[k-b][j]==_R||(r=!1):void 0,!r)return!1;a[k][j]=n;for(let s=!1,t=0;!1==s&&5>t;){const u=e();"s"===u?(a[k+b]&&(s=f(j,k+b,a[k+b][j],n,"s")),a[k][j+b]&&(s=f(j+b,k,a[k][j+b],n,"e")),a[k][j-b]&&(s=f(j-b,k,a[k][j-b],n,"w"))):"n"===u?(a[k-b]&&(s=f(j,k-b,a[k-b][j],n,"n")),a[k][j-b]&&(s=f(j-b,k,a[k][j-b],n,"w")),a[k][j+b]&&(s=f(j+b,k,a[k][j+b],n,"e"))):"w"===u?(a[k][j-b]&&(s=f(j-b,k,a[k][j-b],n,"w")),a[k-b]&&(s=f(j,k-b,a[k-b][j],n,"n")),a[k+b]&&(s=f(j,k+b,a[k+b][j],n,"s"))):"e"===u?(a[k][j+b]&&(s=f(j+b,k,a[k][j+b],n,"e")),a[k-b]&&(s=f(j,k-b,a[k-b][j],n,"n")),a[k+b]&&(s=f(j,k+b,a[k+b][j],n,"s"))):void 0,t++}return!0};for(let j=0;j<MAP_SIZE;j++)for(let k=0;k<MAP_SIZE;k++)a[j][k]==_R&&a[j-b]&&a[j+b]&&a[j][k-b]&&a[j][k+b]&&a[j-b][k]==_R&&a[j+b][k]==_R&&a[j][k-b]==_R&&a[j][k+b]==_R&&f(k,j,_R,_H,e());return a}connectRooms(a){const b=this.map,e=(f,j,k)=>{return b[j-1]&&b[j-1][f]==k||b[j+1]&&b[j+1][f]==k||!(b[j][f-1]!=k)||!(b[j][f+1]!=k)};a.forEach(f=>{const j=[];for(let l=f.y-1;l<f.y+f.height+1;l++)for(let n=f.x-1;n<f.x+f.width+1;n++)b[l][n]==_R&&e(n,l,_O)&&e(n,l,_H)&&j.push({x:n,y:l});for(let l=0;l<4;l++){const n=Math.round(Math.random()*(j.length-1)),o=j[n];o&&(b[o.y][o.x]=_D,b[o.y-1][o.x]===_R&&(b[o.y-1][o.x]=_R_N))}})}removeDeadEnds(){const a=this.map;for(let b=!1;!b;){b=!0;for(let e=0;e<MAP_SIZE;e++)for(let f=0;f<MAP_SIZE;f++)if(a[e][f]==_H||a[e][f]==_D){let j=0;a[e-1]&&a[e-1][f]!=_R&&j++,a[e+1]&&a[e+1][f]!=_R&&j++,a[e][f-1]!=_R&&j++,a[e][f+1]!=_R&&j++,2>j&&(a[e][f]=_R,b=!1)}}for(let e=0;e<MAP_SIZE;e++)for(let f=0;f<MAP_SIZE;f++)a[e-1]&&a[e][f]===_H&&a[e-1][f]===_R&&(a[e-1][f]=_R_N)}generateItems(){this.rooms.forEach(a=>{const b=a.randomLocationInRoom(),e=new Oil(b.x,b.y);this.addItem(e);const f=a.randomLocationInRoom(),j=new Picture(f.x,f.y);this.addItem(j)})}addItem(a){this.items.push(a)}generate(){this.rooms=this.generateRooms(this.map),this.generateMaze(),this.connectRooms(this.rooms),this.removeDeadEnds(),this.generateItems(),this.startingRoom=this.randomRoom()}randomRoom(){return this.rooms[Math.round(Math.random()*(this.rooms.length-1))]}toggleDoor(a,b){this.map[b][a]==_D?this.map[b][a]=_B:this.map[b][a]==_B&&(this.map[b][a]=_D)}render(){this.renderMap(),this.renderItems(),this.renderCharacters(),this.renderPlayerLightRadius()}renderMap(){const a=this.map,b=this.player;this.ctx.fillStyle=C[_BG],this.ctx.fillRect(1,1,MAP_SIZE*TILE_SIZE,MAP_SIZE*TILE_SIZE);for(let e=Math.floor(this.vpStart("y"));e<Math.floor(this.vpStart("y"))+VIEWPORT-_;e++)for(let f=Math.floor(this.vpStart("x"));f<Math.floor(this.vpStart("x"))+VIEWPORT-_;f++)if(a[e]&&a[e][f]){const j=this.vpAdjust(f,"x")*TILE_SIZE,k=this.vpAdjust(e,"y")*TILE_SIZE;if(C[a[e][f]]&&(this.ctx.fillStyle=C[a[e][f]],this.ctx.fillRect(j,k,TILE_SIZE+_,TILE_SIZE+_)),IMG[a[e][f]]&&this.ctx.drawImage(IMG[a[e][f]],j-_,k-_,TILE_SIZE+_,TILE_SIZE+_),a[e][f]==_D||a[e][f]==_B){const l=a[e][f]==_D?0:1;a[e-1][f]==_O||a[e+1][f]==_O?this.ctx.drawImage(...this.s_door_ns.getDrawArgsForIndex(l,j,k)):this.ctx.drawImage(...this.s_door_ew.getDrawArgsForIndex(l,j,k))}}}renderCharacters(){this.characters.forEach(a=>{const b=this.vpAdjustRealCoord(a.loc.x,"x"),e=this.vpAdjustRealCoord(a.loc.y,"y");a.drawSprite(this.ctx,b,e)})}renderItems(){this.items.forEach(a=>{const b=this.vpAdjust(a.x,"x")*TILE_SIZE,e=this.vpAdjust(a.y,"y")*TILE_SIZE;this.ctx.drawImage(a.img,b,e)})}vpAdjust(a,b){return a-this.vpStart(b)}vpAdjustRealCoord(a,b){return a-this.vpStart(b)*TILE_SIZE}vpStart(a){let b=this.player.loc[a]/TILE_SIZE-VIEWPORT/2.5+_;return 0>b&&(b=0),b}renderPlayerLightRadius(){if(!this.player)return!1;const a=this.player,b=a.loc,e=this.vpAdjustRealCoord(b.x,"x")+TILE_SIZE/4,f=this.vpAdjustRealCoord(b.y,"y")+TILE_SIZE/4,k=3-0.3*(a.torch-10),l=this.ctx.createRadialGradient(e,f,VIEWPORT_SIZE/(k+Math.random()*0.12),e,f,0);l.addColorStop(0,"black"),l.addColorStop(1,"rgba(0,0,0,0)"),this.ctx.fillStyle=l,this.ctx.fillRect(e-VIEWPORT_SIZE/2,f-VIEWPORT_SIZE/2,2*VIEWPORT_SIZE,2*VIEWPORT_SIZE)}}class Game{constructor(a,b){this.game_text="",this.current_consecutive_game=0,this.TORCH_DEGRADE_INTERVAL=12,this.TORCH_DEGRADE_RATE=1,this.GAME_START=performance.now(),this.current_second=0,this.changeDirection=this.changeDirection.bind(this),this.stopMovement=this.stopMovement.bind(this),this.gameLoop=this.gameLoop.bind(this),this.level=a,this.player=b,this.bindKeys(),this.placePlayer(),setTimeout(()=>{this.placeMonster()},1e3),this.level.setPlayer(b),this.audioSetup(),this.gameLoop(),this.dirTransform={w:"n",a:"w",s:"s",d:"e",e:"e"}}audioSetup(){this.aCtx=new AudioContext,this.ma_osc=this.aCtx.createOscillator(),this.ma_gain=this.aCtx.createGain(),this.ma_panner=this.aCtx.createPanner(),this.ma_panner.panningModel="HRTF",this.ma_panner.distanceModel="inverse",this.ma_panner.refDistance=1,this.ma_panner.maxDistance=MAP_SIZE,this.ma_panner.rolloffFactor=1,this.ma_panner.coneInnerAngle=360,this.ma_panner.coneOuterAngle=0,this.ma_panner.coneOuterGain=0,this.ma_osc.frequency.value=35.75,this.ma_gain.gain.value=2,this.ma_osc.type="triangle",this.ma_osc.connect(this.ma_gain),this.ma_gain.connect(this.ma_panner),this.ma_panner.connect(this.aCtx.destination),this.aCtx.listener.setPosition(this.player.loc.x/TILE_SIZE,this.player.loc.y/TILE_SIZE,0),this.ma_osc.start(0)}gameLoop(){this.level.render(),this.torchLoop(),this.textLoop(),this.monsterSoundAura(),setTimeout(()=>{window.requestAnimationFrame(this.gameLoop)},50)}torchLoop(){const a=Math.floor(Math.floor(performance.now()-this.GAME_START)/1e3);a>this.current_second&&0==this.current_second%this.TORCH_DEGRADE_INTERVAL&&--this.player.torch}monsterSoundAura(){this.monster&&(this.ma_panner.setPosition((this.monster.loc.x+this.monster.w/2)/TILE_SIZE,(this.monster.loc.y+this.monster.h/2)/TILE_SIZE,0),this.aCtx.listener.setPosition(this.player.loc.x/TILE_SIZE,this.player.loc.y/TILE_SIZE,0))}setText(a){this.game_text=a,this.current_text_letter=0}textLoop(){this.level.ctx.font="24px Courier",this.level.ctx.fillStyle="white",this.level.ctx.fillText(this.game_text.substr(0,this.current_text_letter),100,750);const a=Math.floor(Math.floor(performance.now()-this.GAME_START)/1e3);a>this.current_second&&0==this.current_second%1&&(this.game_text.length>this.current_text_letter&&(this.current_text_letter+=1),this.current_second=a)}bindKeys(){document.addEventListener("keypress",this.changeDirection),document.addEventListener("keyup",this.stopMovement)}placePlayer(){const a=this.level.startingRoom,b=a.x+Math.floor(a.width/2),e=a.y+Math.floor(a.height/2);this.player.teleport(b*TILE_SIZE,e*TILE_SIZE),this.level.placeCharacter(this.player)}placeMonster(){const a=new Monster,b=this.player.loc;a.teleport(b.x,b.y),this.level.placeCharacter(a),this.monster=a,this.setText(this.monster.ng_dialog[this.current_consecutive_game])}stopMovement(a){this.player.stopMovement(this.dirTransform[a.key])}changeDirection(a){this.player.move;"e"==a.key?this.player.interact():this.player.move(this.dirTransform[a.key])}}class Character{constructor(a){this.TILE=_P,this.loc={x:0,y:0},this.dungeon=a,this.move=this.move.bind(this),this.interact=this.interact.bind(this),this.state={moving:!1,direction:"s",sprite_index:0}}drawSprite(a,b,e){a.drawImage(...this.getCurrentSpriteArgs(b,e))}getCurrentSpriteArgs(a,b){return this.state.moving?this["s_walk_"+this.state.direction].getDrawArgsForIndex(this.state.sprite_index,a,b):this.s_idle.getDrawArgsForIndex(DIR.indexOf(this.state.direction),a,b)}interact(){const a=Math.floor((this.loc.x+this.w/2)/TILE_SIZE),b=Math.floor((this.loc.y+this.h/2)/TILE_SIZE);[{x:a,y:b},{x:a,y:b-1},{x:a-1,y:b},{x:a,y:b+1},{x:a+1,y:b}].forEach(j=>{{const k=this.dungeon.map[j.y][j.x];(k==_D||k==_B)&&this.dungeon.toggleDoor(j.x,j.y)}})}move(a){if(this.state.moving&&this.state.direction==a)return!1;let b=0;const e=f=>{if(this.state.moving&&this.state.direction===f){const j={x:this.loc.x,y:this.loc.y},k=this.SPEED;"n"===f?j.y=this.loc.y-k:"w"===f?j.x=this.loc.x-k:"s"===f?j.y=this.loc.y+k:"e"===f?j.x=this.loc.x+k:void 0;this.isValidLoc(j)&&(this.loc=j),30>b%this.spriteCadence&&this.nextSprite(),b+=30,setTimeout(()=>{e(f)},30)}};this.state.moving=!0,this.state.direction=a,e(a)}nextSprite(){return 3<this.state.sprite_index+1?this.state.sprite_index=0:this.state.sprite_index+=1,this.state.sprite_index}stopMovement(a){this.state.direction===a&&(this.state.moving=!1,this.state.sprite_index=!1)}isValidLoc(a){const b=s=>{return Math.floor(s/TILE_SIZE)},e=(s,t)=>{if(!this.dungeon.map[t]||!this.dungeon.map[t][s])return!1;const u=this.dungeon.map[t][s];return u==_O||u==_H||u==_B},f=b(a.x),j=b(a.y),k=b(a.x+34),o=b(a.y+47);return e(f,o)&&e(k,o)}teleport(a,b){this.loc={x:a,y:b}}}class Player extends Character{constructor(a){super();const b="img_prod/s_pc_";this.w=34,this.h=47,this.animated=!0,this.SPEED=0.15*TILE_SIZE,this.s_idle=new Sprite(b+"idle-min.png",this.w,this.h),DIR.forEach(e=>{this["s_walk_"+e]=new Sprite(b+"walk_"+e+"-min.png",this.w,this.h)}),this.dungeon=a,this.torch=12,this.spriteCadence=100}}class Enemy extends Character{}class Monster extends Enemy{constructor(){super();const a="img_prod/monster_walk_";this.animated=!0,this.w=128,this.h=64,this.s_idle=new Sprite(a+"w-min.png",this.w,this.h),DIR.forEach(b=>{this["s_walk_"+b]=new Sprite(a+"w-min.png",this.w,this.h)}),this.TILE=E_S,this.dialog=["oh, I wouldn't do that...","you'll hurt yourself running like that.","what is it you're trying to do?","i'll find you eventually.","i always do...","it's rude to run you know"],this.ng_dialog=["are you lost...?","oh... you're back.","I just want to talk this time, I promise..."]}pixelate(a,b,e,f,j,k){for(let q=b;q<b+f;q+=k)for(let r=e;r<e+j;r+=k)if(0.5<Math.random()*2){const s=0.3;var n=a.getImageData(q,r,k,k);const u=q+Math.random()*s,v=r+Math.random()*s;var o=a.getImageData(u,v,k,k);a.fillStyle="rgb("+o.data[0]+","+o.data[1]+","+o.data[2]+")",a.fillRect(q,r,k,k),a.fillStyle="rgb("+n.data[0]+","+n.data[1]+","+n.data[2]+")",a.fillRect(u,v,k,k)}}drawSprite(a,b,e){a.drawImage(...this.getCurrentSpriteArgs(b,e)),this.pixelate(a,b,e,this.w,this.h,8)}}const canvas=document.getElementById("game"),d=new Dungeon(canvas),g=new Game(d,new Player(d));
