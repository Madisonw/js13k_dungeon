const IMG_FLOOR=new Image;IMG_FLOOR.src="img_prod/floor.png";const TILE_SIZE=64,PLAYER_SIZE=TILE_SIZE/2,MAP_SIZE=50,VIEWPORT=12,VIEWPORT_SIZE=TILE_SIZE*VIEWPORT,DIR=["s","n","e","w"],_=1,_BG="bg",_O="r",_H="h",_R="k",_D="d",_B="b",_P="p",E_S="e_s",C={},IMG={};C[E_S]="#ceceb5",C[_BG]="black",C[_O]="#777",C[_H]=C[_O],C[_R]="black",C[_D]="#513520",C[_B]="#c1ad9e",C[_P]="orange",IMG[_O]=IMG_FLOOR,IMG[_H]=IMG_FLOOR;class Sprite{constructor(a,b,e){this.img=new Image,this.img.src=a,this.width=b,this.height=e,this.getDrawArgsForIndex=this.getDrawArgsForIndex.bind(this)}getDrawArgsForIndex(a,b,e){const f=this.width,j=this.height;return[this.img,a*f,0,f,j,b,e,f,j]}}class Room{constructor(a,b,e,f){this.x=a,this.y=b,this.width=e,this.height=f}randomLocationInRoom(){return{x:this.x+Math.floor(Math.random()*this.width),y:this.y+Math.floor(Math.random()*this.height)}}}class Dungeon{constructor(a){this.characters=[],this.canvas=a,this.ctx=this.canvas.getContext("2d"),this.map=Array(MAP_SIZE);for(let b=0;b<MAP_SIZE;b++){this.map[b]=Array(MAP_SIZE);for(let e=0;e<MAP_SIZE;e++)this.map[b][e]=_R}this.generate()}placeCharacter(a){this.characters.unshift(a)}setPlayer(a){this.player=a}generateRooms(a){let l=[];const n=(q,r)=>{return q.x<r.x+r.width&&q.x+q.width>r.x&&q.y<r.y+r.height&&q.height+q.y>r.y},o=q=>{let r=!0;return l.forEach(s=>{!1==r||n(s,q)&&(r=!1)}),r};for(let q=0;q<800;q++){const r=7+Math.round(Math.random()*11),s=7+Math.round(Math.random()*11),t=Math.round(Math.random()*(MAP_SIZE-r-1)),u=Math.round(Math.random()*(MAP_SIZE-s-1)),v=new Room(t,u,r,s);o(v)&&l.push(v)}return l.map(q=>{q.x+=_,q.width-=_,q.y+=_,q.height-=_;for(let r=q.y;r<q.y+q.height;r++)for(let s=q.x;s<q.x+q.width;s++)a[r][s]=_O;return q})}generateMaze(){const a=this.map,b=1,e=()=>{return DIR[Math.round(Math.random()*DIR.length)]},f=(j,k,l,n,o)=>{const q=a[k][j];if(q!=l)return!1;if(q!=_R)return!1;let r=!0;if("s"===o?a[k+b]&&a[k+b][j]==_R&&a[k][j-b]==_R&&a[k][j+b]==_R||(r=!1):"n"===o?a[k-b]&&a[k-b][j]==_R&&a[k][j-b]==_R&&a[k][j+b]==_R||(r=!1):"w"===o?a[k][j-b]&&a[k][j-b]==_R&&a[k+b]&&a[k+b][j]==_R&&a[k-b]&&a[k-b][j]==_R||(r=!1):"e"===o?a[k][j+b]&&a[k][j+b]==_R&&a[k+b]&&a[k+b][j]==_R&&a[k-b]&&a[k-b][j]==_R||(r=!1):void 0,!r)return!1;a[k][j]=n;for(let s=!1,t=0;!1==s&&5>t;){const u=e();"s"===u?(a[k+b]&&(s=f(j,k+b,a[k+b][j],n,"s")),a[k][j+b]&&(s=f(j+b,k,a[k][j+b],n,"e")),a[k][j-b]&&(s=f(j-b,k,a[k][j-b],n,"w"))):"n"===u?(a[k-b]&&(s=f(j,k-b,a[k-b][j],n,"n")),a[k][j-b]&&(s=f(j-b,k,a[k][j-b],n,"w")),a[k][j+b]&&(s=f(j+b,k,a[k][j+b],n,"e"))):"w"===u?(a[k][j-b]&&(s=f(j-b,k,a[k][j-b],n,"w")),a[k-b]&&(s=f(j,k-b,a[k-b][j],n,"n")),a[k+b]&&(s=f(j,k+b,a[k+b][j],n,"s"))):"e"===u?(a[k][j+b]&&(s=f(j+b,k,a[k][j+b],n,"e")),a[k-b]&&(s=f(j,k-b,a[k-b][j],n,"n")),a[k+b]&&(s=f(j,k+b,a[k+b][j],n,"s"))):void 0,t++}return!0};for(let j=0;j<MAP_SIZE;j++)for(let k=0;k<MAP_SIZE;k++)a[j][k]==_R&&a[j-b]&&a[j+b]&&a[j][k-b]&&a[j][k+b]&&a[j-b][k]==_R&&a[j+b][k]==_R&&a[j][k-b]==_R&&a[j][k+b]==_R&&f(k,j,_R,_H,e());return a}connectRooms(a){const b=this.map,e=(f,j,k)=>{return b[j-1]&&b[j-1][f]==k||b[j+1]&&b[j+1][f]==k||!(b[j][f-1]!=k)||!(b[j][f+1]!=k)};a.forEach(f=>{const j=[];for(let l=f.y-1;l<f.y+f.height+1;l++)for(let n=f.x-1;n<f.x+f.width+1;n++)b[l][n]==_R&&e(n,l,_O)&&e(n,l,_H)&&j.push({x:n,y:l});for(let l=0;l<4;l++){const n=Math.round(Math.random()*(j.length-1)),o=j[n];b[o.y][o.x]=_D}})}removeDeadEnds(){const a=this.map;for(let b=!1;!b;){b=!0;for(let e=0;e<MAP_SIZE;e++)for(let f=0;f<MAP_SIZE;f++)if(a[e][f]==_H||a[e][f]==_D){let j=0;a[e-1]&&a[e-1][f]!=_R&&j++,a[e+1]&&a[e+1][f]!=_R&&j++,a[e][f-1]!=_R&&j++,a[e][f+1]!=_R&&j++,2>j&&(a[e][f]=_R,b=!1)}}}generateMonster(){}generate(){this.rooms=this.generateRooms(this.map),this.generateMaze(),this.connectRooms(this.rooms),this.removeDeadEnds(),this.generateMonster(),this.startingRoom=this.randomRoom()}randomRoom(){return this.rooms[Math.round(Math.random()*(this.rooms.length-1))]}toggleDoor(a,b){this.map[b][a]==_D?this.map[b][a]=_B:this.map[b][a]==_B&&(this.map[b][a]=_D)}render(){this.renderMap(),this.renderCharacters(),this.renderPlayerLightRadius()}renderMap(){const a=this.map,b=this.player;this.ctx.fillStyle=C[_BG],this.ctx.fillRect(1,1,MAP_SIZE*TILE_SIZE,MAP_SIZE*TILE_SIZE);for(let e=Math.floor(this.vpStart("y"));e<Math.floor(this.vpStart("y"))+VIEWPORT-_;e++)for(let f=Math.floor(this.vpStart("x"));f<Math.floor(this.vpStart("x"))+VIEWPORT-_;f++)a[e]&&a[e][f]&&(IMG[a[e][f]]?this.ctx.drawImage(IMG[a[e][f]],this.vpAdjust(f,"x")*TILE_SIZE,this.vpAdjust(e,"y")*TILE_SIZE,TILE_SIZE,TILE_SIZE):(this.ctx.fillStyle=C[a[e][f]],this.ctx.fillRect(this.vpAdjust(f,"x")*TILE_SIZE,this.vpAdjust(e,"y")*TILE_SIZE,TILE_SIZE+_,TILE_SIZE+_)))}renderCharacters(){this.player;this.characters.forEach(b=>{if(b.animated){const e=this.vpAdjustRealCoord(b.loc.x,"x"),f=this.vpAdjustRealCoord(b.loc.y,"y");b.drawSprite(this.ctx,e,f)}else this.ctx.fillStyle=C[b.TILE],this.ctx.fillRect(this.vpAdjustRealCoord(b.loc.x,"x"),this.vpAdjustRealCoord(b.loc.y,"y"),PLAYER_SIZE,PLAYER_SIZE)})}vpAdjust(a,b){return a-this.vpStart(b)}vpAdjustRealCoord(a,b){return a-this.vpStart(b)*TILE_SIZE}vpStart(a){let b=this.player.loc[a]/TILE_SIZE-VIEWPORT/2+_;return 0>b&&(b=0),b}renderPlayerLightRadius(){if(!this.player)return!1;const a=this.player,b=a.loc,e=this.vpAdjustRealCoord(b.x,"x")+TILE_SIZE/4,f=this.vpAdjustRealCoord(b.y,"y")+TILE_SIZE/4,k=3-0.3*(a.torch-10),l=this.ctx.createRadialGradient(e,f,VIEWPORT_SIZE/(k+Math.random()*0.12),e,f,0);l.addColorStop(0,"black"),l.addColorStop(1,"rgba(0,0,0,0)"),this.ctx.fillStyle=l,this.ctx.fillRect(e-VIEWPORT_SIZE/2,f-VIEWPORT_SIZE/2,2*VIEWPORT_SIZE,2*VIEWPORT_SIZE)}}class Game{constructor(a,b){this.TORCH_DEGRADE_INTERVAL=8,this.TORCH_DEGRADE_RATE=1,this.GAME_START=performance.now(),this.current_second=0,this.changeDirection=this.changeDirection.bind(this),this.stopMovement=this.stopMovement.bind(this),this.gameLoop=this.gameLoop.bind(this),this.level=a,this.player=b,this.bindKeys(),this.placePlayer(),this.placeMonster(),this.level.setPlayer(b),this.gameLoop(),this.dirTransform={w:"n",a:"w",s:"s",d:"e",e:"e"},this.GAME_TEXT="run away"}gameLoop(){this.level.render(),this.torchLoop(),this.textLoop(),window.requestAnimationFrame(this.gameLoop)}torchLoop(){const a=performance.now(),b=Math.floor(Math.floor(a-this.GAME_START)/1e3);b>this.current_second&&(this.current_second=b,0==this.current_second%this.TORCH_DEGRADE_INTERVAL&&--this.player.torch)}textLoop(){this.level.ctx.font="12px white",this.level.ctx.strokeText(this.GAME_TEXT,20,400)}bindKeys(){document.addEventListener("keypress",this.changeDirection),document.addEventListener("keyup",this.stopMovement)}placePlayer(){const a=this.level.startingRoom,b=a.x+Math.floor(a.width/2),e=a.y+Math.floor(a.height/2);this.player.teleport(b*TILE_SIZE,e*TILE_SIZE),this.level.placeCharacter(this.player)}placeMonster(){const a=new Monster;a.teleport(this.player.loc.x+TILE_SIZE,this.player.loc.y),this.level.placeCharacter(a)}stopMovement(a){this.player.stopMovement(this.dirTransform[a.key])}changeDirection(a){this.player.move;"e"==a.key?this.player.interact():this.player.move(this.dirTransform[a.key])}}class Character{constructor(a){this.TILE=_P,this.loc={x:0,y:0},this.dungeon=a,this.move=this.move.bind(this),this.interact=this.interact.bind(this),this.state={moving:!1,direction:"s",sprite_index:0}}drawSprite(a,b,e){a.drawImage(...this.getCurrentSpriteArgs(b,e))}getCurrentSpriteArgs(a,b){return this.state.moving?this["s_walk_"+this.state.direction].getDrawArgsForIndex(this.state.sprite_index,a,b):this.s_idle.getDrawArgsForIndex(DIR.indexOf(this.state.direction),a,b)}interact(){const a=Math.floor(this.loc.x/TILE_SIZE),b=Math.floor(this.loc.y/TILE_SIZE);[{x:a,y:b-1},{x:a-1,y:b},{x:a,y:b+1},{x:a+1,y:b}].forEach(j=>{{const k=this.dungeon.map[j.y][j.x];(k==_D||k==_B)&&this.dungeon.toggleDoor(j.x,j.y)}})}move(a){if(this.state.moving&&this.state.direction==a)return!1;let b=0;const e=f=>{if(this.state.moving&&this.state.direction===f){const j={x:this.loc.x,y:this.loc.y},k=this.SPEED;"n"===f?j.y=this.loc.y-k:"w"===f?j.x=this.loc.x-k:"s"===f?j.y=this.loc.y+k:"e"===f?j.x=this.loc.x+k:void 0;this.isValidLoc(j)&&(this.loc=j),30>b%this.footstepCadence&&this.footstep&&this.footstep.play(),30>b%this.spriteCadence&&this.nextSprite(),b+=30,setTimeout(()=>{e(f)},30)}};this.state.moving=!0,this.state.direction=a,e(a)}nextSprite(){return 3<this.state.sprite_index+1?this.state.sprite_index=0:this.state.sprite_index+=1,this.state.sprite_index}stopMovement(a){this.state.direction===a&&(this.state.moving=!1,this.state.sprite_index=!1)}isValidLoc(a){const b=s=>{return Math.floor(s/TILE_SIZE)},e=(s,t)=>{if(!this.dungeon.map[t]||!this.dungeon.map[t][s])return!1;const u=this.dungeon.map[t][s];return u==_O||u==_H||u==_B},f=b(a.x),j=b(a.y),k=b(a.x+PLAYER_SIZE),o=b(a.y+PLAYER_SIZE);return e(f,j)&&e(k,j)&&e(f,o)&&e(k,o)}teleport(a,b){this.loc={x:a,y:b}}}class Player extends Character{constructor(a){super();const b="img_prod/s_pc_",e=34,f=47;this.animated=!0,this.SPEED=0.15*TILE_SIZE,this.s_idle=new Sprite(b+"idle.png",e,f),DIR.forEach(j=>{this["s_walk_"+j]=new Sprite(b+"walk_"+j+".png",e,f)}),this.dungeon=a,this.torch=10,this.footstep=new Audio("footstep.mp3"),this.footstep.volume=0.2,this.footstepCadence=100,this.spriteCadence=100}}class Enemy extends Character{}class Monster extends Enemy{constructor(){super(),this.animated=!0,this.w=200,this.h=200,this.s_idle=new Sprite("slenderman.png",this.w,this.h),this.TILE=E_S}pixelate(a,b,e,f,j,k){for(let n=b;n<b+f;n+=k/2)for(let o=e;o<e+j;o+=k/2){const q=0.5,r=-0.5,s=Math.round(Math.random()*f),t=Math.round(Math.random()*j);var l=a.getImageData(n+s,o+t,1,1);a.fillStyle="rgb("+l.data[0]+","+l.data[1]+","+l.data[2]+")";const u=s+(Math.random()*(q-r)+r),v=t+(Math.random()*(q-r)+r);a.fillRect(n+u,o+v,7,7)}}drawSprite(a,b,e){a.drawImage(...this.getCurrentSpriteArgs(b,e)),this.pixelate(a,b-this.w,e-this.h,1.5*this.w,1.5*this.h,10)}}const canvas=document.getElementById("game"),d=new Dungeon(canvas),g=new Game(d,new Player(d));
